$(function() {
  var root = "<%= Discourse.base_url %>"
	$(".full-calendar").each(function() {
		var url = $(this).attr("data-calendar-url")
		$(this).fullCalendar(
		{
			events: url, 
			titleFormat: {
				month: "'Kalenteri: 'MMMM"
			},
      dayNames: ['Sunnuntai', 'Maanantai', 'Tiistai', 'Keskiviikko',
 'Torstai', 'Perjantai', 'Lauantai'],
      dayNamesShort: ['Su', 'Ma', 'Ti', 'Ke', 'To', 'Pe', 'La'],
      monthNames: ['tammikuu', 'helmikuu', 'maaliskuu', 'huhtikuu', 'toukokuu', 'kesäkuu', 'heinäkuu',
 'elokuu', 'syyskuu', 'lokakuu', 'marraskuu', 'joulukuu'],
      timeFormat: '',
      firstDay: 1,
      eventRender: function(event, element) {
        var url = event.description;
        if(!url) return;
        $(element).first("a").attr("href", url)
      },
      dayRender: function(date, cell) { 
        var formattedDate = date.getDate() + "." + date.getMonth() + "." + date.getFullYear();
        <% if @loggedIn %>
        var href = root + '/create_event/' + formattedDate;
        <% else %>
        var href = root + '/signup/';
        <% end %>

        var a = $("<a/>", { href: root + '/create_event/' + formattedDate })
          .append($('<i class="font-icon-plus-sign"/>'))
        var create_event = $('<div class="fc-create-event"/>').append(a);

        $(cell).find(".fc-day-number").before(create_event);
        return cell;
      },
      buttonText: {
        prev:     '&lsaquo;', // <
        next:     '&rsaquo;', // >
        prevYear: '&laquo;',  // <<
        nextYear: '&raquo;',  // >>
        today:    'tänään',
        month:    'kuukausi',
        week:     'viikko',
        day:      'päivä'
      }
		});
	})
});

customFilter = function (container, layoutMode){
  var filters = {}
  var $container = $('#' + container);
  
  $container.imagesLoaded(function() {
    $container.isotope({
      // options
      animationEngine: 'best-available',
      itemSelector : '.item-thumbs',
      layoutMode : layoutMode? layoutMode: 'straightDown',
      filter: ':not(.past)'
    });
  });

  
  // filter items when filter link is clicked
  var $optionSets = $('.' + container + '-options .option-set'),
    $optionLinks = $optionSets.find('a');

  var less = ":nth-child(-n+5)";
  var limiter = less;
  var name = container;
  var $toggle = $("#" + container + "-toggle");
  
  var selector = function() {
    var isoFilters = [];
    for ( var prop in filters ) {
      isoFilters.push( filters[ prop ] )
    }
    return isoFilters.join('') || '*';
  }

  $toggle.click(function() {
    var $this = $(this);
    if(!limiter) {
      limiter = less;
      $this.text("Lisää")
    }
    else {
      limiter = "";
      $this.text("Vähemmän")
    }

    $container.isotope( { filter: selector() + limiter });
  })

  $optionLinks.click(function(){
    var $this = $(this);
    // don't proceed if already selected
    if ( $this.hasClass('selected') ) {
      return false;
    }
    var $optionSet = $this.parents('.option-set');
    $optionSet.find('.selected').removeClass('selected');
  
    // make option object dynamically, i.e. { filter: '.my-filter-class' }
    var options = {},
      key = $optionSet.attr('data-option-key'),
      value = $this.attr('data-option-value');

    filters[ key ] = value;
    $this.addClass('selected');

    limiter = less;
    
    $container.isotope( { filter: selector() + limiter }, 
      function($changedItems, instance) {
          var all = instance.$allAtoms;
          var cur = instance.$filteredAtoms.length;
          var full = all.filter(selector).length;
          if(cur < full || !limiter) $toggle.show();
          else $toggle.hide();
        } );
    
    return false;
  });
}

$(document).ready(function(){
  customFilter('projects', 'fitRows');
  customFilter('eventslist', 'straightDown');
});

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-49613065-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();